<!DOCTYPE html>
<html>
	<head>
	  <meta charset="utf-8">
	  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	  <meta name="description" content="">
	  <meta name="author" content="RTS">
	  <title>Hello</title>
	  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	  <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
	  <script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
	</head>
	<body class='container'>
	    <div style='width:580px;overflow:hidden;'>
			<div id='grid' style='position: relative; width:593px;'>
			    <div id='score' style='position: absolute; left:90%;font-size:33px;font-weight: bold;size: 30px;color: #6c91ff;'>0</div>
				<div id='user' style='position:absolute;top:300px;'>
					<image src='image/user.gif' style=" transform: scaleX(-1);width:180px;">
				</div>
				<canvas id='backgroundSicne' width='592' height='500'> </canvas>
			</div>
		</div>
	</body>
</html>
<script>
var STOP = false;
var ppp = 1;
makeEnemy(ppp);

var player = setInterval(function(){
	if(STOP){
		clearInterval(player);
	}
	ppp++;
	var makeMore = Math.floor(Math.random() * 10); 
	makeEnemy(ppp);
	setTimeout(function(){
		ppp++;
		makeEnemy(ppp);
	}, makeMore * 50);
},Math.floor(Math.random() * 4500));

 

function makeEnemy(idNumer){
	var BOX = "<div class='box' id='box-"+idNumer+"' style='width:20px;height:100px;position:absolute;top:400px;border:3px solid blue; left:101%;'></div>";
	$('#grid').append(BOX);
	var num = 100;
	var mmm = setInterval(function(){
		if(STOP){
			clearInterval(mmm);
		}
		$('#'+'box-'+idNumer).css('left',num+"%");
		num -= (Math.random() * (0.050 - 0.600) + 0.600).toFixed(4);
		if(num <= 1){
			$('#'+'box-'+idNumer).remove();
			var score = Number($('#score').text());
			score += 100;
			$('#score').text(score);
			clearInterval(mmm);
		}
		$('.box').each(function(evt){
			eventPosition($(this).offset());
		});
	},5);
}


 $(document).keydown(function(event){
	event.stopPropagation();
	if(event.keyCode == 32){
		moveMove();
		return false;
	}
	return true;
 });


var radius = 20;  //높이

//위치 체커
function eventPosition(evt){ 
	var client_x = evt.left + radius;
    var client_y = evt.top + radius;
    var offset = $('#user').offset();
    var canvas_x = offset.left + 180; //클라 180 x축 끝     200
    var canvas_y = offset.top; 
	//console.log("en : "+client_y +", ali : "+canvas_y);
	if(client_x - canvas_x <= 0){
		if(client_y - canvas_y <= 140){ 
			console.log('x pass!'); 
			//alert('boom!');
			STOP = true;
		}
	}
}


//움직임
function moveMove(jum){	
	var maxiMum = -1;
	var returnNum = 0;
	var stop = false;
	var jumpper = setInterval(function(){
		var pos = $('#user').offset();
		if(maxiMum <= -13){
			stop = true;
			if(returnNum >= 12){
				clearInterval(jumpper);
			}
			$('#user').offset({'top':pos.top += returnNum});
			returnNum++;
		}
		else if(!stop){
			$('#user').offset({'top':pos.top += maxiMum});
			maxiMum --;
		}
	},20);
}


/* Define Background Class */ 
function Background(assetObj,canvasElement){
   this.assetObj = assetObj; 
   this.canvasSize = {width: canvasElement.width, height: canvasElement.height};   //Canvas Size
   this.canvasContext = canvasElement.getContext('2d'); //Canvas Context
   this.spritesX = 0;  //Image X Position 
}

Background.prototype.startAnimation = function(){ 
	//Clear Canvas  
	this.canvasContext.clearRect(0, 0, this.canvasSize.width, this.canvasSize.height);
    //Draw Background Image
	var drawX = this.spritesX * this.assetObj.bgImage.width;
	var drawWidth = this.assetObj.bgImage.width - drawX;
	this.canvasContext.drawImage(this.assetObj.bgImage, 
                    drawX, 0, drawWidth, this.assetObj.bgImage.height, 
                    0, 0, drawWidth, this.assetObj.bgImage.height);     
	if(drawWidth < this.assetObj.bgImage.width) {
        var fillDrawWidth = this.assetObj.bgImage.width - drawWidth;
        this.canvasContext.drawImage(this.assetObj.bgImage,0, 0, fillDrawWidth, this.assetObj.bgImage.height, drawWidth, 0, fillDrawWidth,this.assetObj.bgImage.height);
    }     
	this.spritesX = (this.spritesX + this.assetObj.spritesRate) % 1;
} 

var fps = 60;      //frame per second
var background;    //Character Instance 
var canvasElement; //Canvas Element
var asset;         //Asset Image Ojbect    

function init(){ 
	canvasElement = document.getElementById("backgroundSicne");   
	//Create Asset Image Ojbect
	asset = new Image(); 
	asset.src = 'image/gm_background.png';       
	//Assign Imgae Load Event
	asset.onload = onAssetLoadComplete;  
}

function onAssetLoadComplete(){ 
	var assetObj = {bgImage:asset, spritesRate:0.007}; 
	background = new Background(assetObj,canvasElement);
	setInterval(animationLoop, 1000 / fps); 
}

function animationLoop(){
	background.startAnimation();
}

init();
//gm_background
/*
var config = {
	apiKey: "AIzaSyAT59Nm90cVxZFa5HXCZl_OsWOgPrKNDS8",
	authDomain: "introduce-e531e.firebaseapp.com",
	databaseURL: "https://introduce-e531e.firebaseio.com/"
};
firebase.initializeApp(config);
var database = firebase.database();

writeUserData('hello',300);
writeUserData('world',600);

function writeUserData(userId, name) {
	firebase.database().ref('ranking/'+userId).set({
		id: userId,
		score: name
	});
}


firebase.database().ref('/ranking/').once('value').then(function(datas) {
	console.log(datas.val());
});
*/

</script>
